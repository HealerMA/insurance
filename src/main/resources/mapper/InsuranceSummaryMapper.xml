<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.edu.guet.insurance.mapper.InsuranceSummaryMapper">

    <resultMap id="BaseResultMap" type="cn.edu.guet.insurance.bean.InsuranceSummary">
            <result property="prefecture" column="prefecture" jdbcType="VARCHAR"/>
            <result property="total" column="total" jdbcType="INTEGER"/>
            <result property="january" column="January" jdbcType="INTEGER"/>
            <result property="february" column="February" jdbcType="INTEGER"/>
            <result property="march" column="March" jdbcType="INTEGER"/>
            <result property="april" column="April" jdbcType="INTEGER"/>
            <result property="may" column="May" jdbcType="INTEGER"/>
            <result property="june" column="June" jdbcType="INTEGER"/>
            <result property="july" column="July" jdbcType="INTEGER"/>
            <result property="august" column="August" jdbcType="INTEGER"/>
            <result property="september" column="September" jdbcType="INTEGER"/>
            <result property="october" column="October" jdbcType="INTEGER"/>
            <result property="november" column="November" jdbcType="INTEGER"/>
            <result property="december" column="December" jdbcType="INTEGER"/>
            <result property="totalAmount" column="total_amount" jdbcType="DECIMAL"/>
            <result property="years" column="years" jdbcType="INTEGER"/>
    </resultMap>

    <sql id="Base_Column_List">
        prefecture,total,January,
        February,March,April,
        May,June,July,
        August,September,October,
        November,December,total_amount,
        years
    </sql>
        <!-- 在 InsuranceSummaryMapper.xml 文件中新增一个 insertOrUpdate 方法的实现 -->
    <insert id="insertOrUpdate" parameterType="cn.edu.guet.insurance.bean.InsuranceSummary">

        SELECT * FROM insurance_summary WHERE prefecture = #{prefecture} AND year = #{year}
        <choose>
            <when test="_parameter != null">
                UPDATE insurance_summary SET
                totalAmount = totalAmount + #{totalAmount},
                <!-- 使用 COALESCE 函数处理可能为 null 的月份值，将其转换为 0 进行累加 -->
                January = January + COALESCE(#{january}, 0),
                February = February + COALESCE(#{february}, 0),
                March = March + COALESCE(#{march}, 0),
                April = April + COALESCE(#{april}, 0),
                May = May + COALESCE(#{may}, 0),
                June = June + COALESCE(#{june}, 0),
                July = July + COALESCE(#{july}, 0),
                August = August + COALESCE(#{august}, 0),
                September = September + COALESCE(#{september}, 0),
                October = October + COALESCE(#{october}, 0),
                November = November + COALESCE(#{november}, 0),
                December = December + COALESCE(#{december}, 0)
                WHERE prefecture = #{prefecture} AND year = #{year}
            </when>
            <otherwise>
                INSERT INTO insurance_summary (prefecture, year, totalAmount, January, February, March, April, May, June, July, August, September, October, November, December)
                VALUES (#{prefecture}, #{year}, #{totalAmount}, #{january}, #{february}, #{march}, #{april}, #{may}, #{june}, #{july}, #{august}, #{september}, #{october}, #{november}, #{december})
            </otherwise>
        </choose>
    </insert>

    <select id="findByPrefecture" resultType="cn.edu.guet.insurance.bean.InsuranceSummary">
        SELECT * FROM insurance_summary WHERE prefecture = #{prefecture}
    </select>

</mapper>
